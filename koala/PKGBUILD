# Original Author: oklai
# Maintainer: JokerYu <dayushinn@gmail.com>
pkgname=koala
pkgver=2.0.3
pkgrel=1
pkgdesc="A GUI application for Less, Sass, Compass and CoffeeScript compilation."
arch=("i686" "x86_64")
url="http://koala-app.com/"
license=("Apache")
depends=("gconf" "gtk2" "nss" "libudev.so.0")
optdepends=(
  "ruby: sass compilation support" 
  "lessc: use system less compiler" 
  "ruby-sass: use system sass compiler" 
  "ruby-compass: use system compass compiler" 
  "coffee-script: use system coffee compiler"
)
makedepends=("nodejs" "node-webkit" "rubygems")
conflicts=("koala-deb")
options=(!strip)

# option to build binary, true or false
_buildBinary=false

# rubygems version
_sass=3.3.7
_sass4compass=3.2.9
_compass=0.12.2
_chunky_png=1.2.7
_fssm=0.2.9
_rake=0.9.2.2
_rdoc=3.9.4

source=(
  "https://github.com/oklai/koala/archive/v${pkgver}.tar.gz"
  "http://gems.rubyforge.org/gems/sass-${_sass}.gem"
  "http://gems.rubyforge.org/gems/sass-${_sass4compass}.gem"
  "http://gems.rubyforge.org/gems/compass-${_compass}.gem"
  "http://gems.rubyforge.org/gems/chunky_png-${_chunky_png}.gem"
  "http://gems.rubyforge.org/gems/fssm-${_fssm}.gem"
  "http://gems.rubyforge.org/gems/rake-${_rake}.gem"
  "http://gems.rubyforge.org/gems/rdoc-${_rdoc}.gem"
  "package.json.patch"
  "compass.patch"
  "koala.png" 
  "koala.desktop"
  "koala.sh"
)

md5sums=('93890e5ba5ca0e38b3da57e3767bb489'
         '85c70286e06f0c069f5abac3e7964e41'
         '72364952e435b044f05cc5989528ec8c'
         '84457833289f6f1b11dad10c92ccf216'
         '3b872b1054bd3f586413d9169237432f'
         '50b711e6127d7bbcd11257fe177747ab'
         '28e731d5c59dd721d6387f80b25a2ba1'
         '3d18214b5606e227dea2e6a149cc4075'
         '4be2d52231fc2f7dc68cf13921b34efd'
         '728ae62d7c5de5cc7c14046512ed37b5'
         'cde974f0b5bc366486ec0e1bd4c98ca3'
         '3a1698e629503c336e7b29b38ecbb3a1'
         '4be134fba62b77de9b05d969a619535f')

function buildBinary() {
  cd ${pkgname}-${pkgver}/src

  msg "preparing nw file"
  zip -r ../${pkgname}.nw *

  cd ../
  cat /usr/bin/nw ${pkgname}.nw > ${pkgname}
  msg "build done"
}

function installFiles() {
  install -Dm 644 ${srcdir}/koala.png ${pkgdir}/opt/${pkgname}/
  install -Dm 644 ${srcdir}/${pkgname}.desktop ${pkgdir}/usr/share/applications/
  if [[ $_buildBinary = true ]]; then
      ln -s ${pkgdir}/opt/${pkgname}/${pkgname}  ${pkgdir}/usr/bin/${pkgname}
      # keep node-webkit
      ln -s /usr/lib/node-webkit/nw.pak ${pkgdir}/opt/${pkgname}/
      # cp /usr/lib/node-webkit/nw.pak ${pkgdir}/opt/${pkgname}/
      install -Dm 755 ${srcdir}/${pkgname}-${pkgver}/${pkgname} ${pkgdir}/opt/${pkgname}
  else
      install -Dm 755 ${srcdir}/${pkgname}.sh ${pkgdir}/usr/bin/${pkgname}
      ln -s /usr/lib/node-webkit/nw.pak 
      cp -r ${srcdir}/${pkgname}-${pkgver}/src/* ${pkgdir}/opt/${pkgname}/
  fi
}

build() {
  msg "fixing npm json error, disable frameless window , debug & toolbar"
  patch -p1 -i package.json.patch

  cd ${pkgname}-${pkgver}/src
  msg "installing node modules"
  npm install clean-css coffee-script less uglify-js autoprefixer
}

package() {
  msg "making path"
  mkdir -p ${pkgdir}/opt/${pkgname}
  mkdir -p ${pkgdir}/usr/share/applications
  mkdir -p ${pkgdir}/usr/bin

  msg "installing ruby gems"
  _gemdir="${srcdir}/${pkgname}-${pkgver}/src/rubygems"
  _gembin="${_gemdir}/bin"
  gem install --no-user-install --ignore-dependencies --no-ri --no-rdoc\
    -i "${_gemdir}" -n "${_gembin}" "sass-${_sass}.gem" \
                                    "sass-${_sass4compass}.gem" \
                                    "compass-${_compass}.gem" \
                                    "chunky_png-${_chunky_png}.gem" \
                                    "fssm-${_fssm}.gem" \
                                    "rake-${_rake}.gem" \
                                    "rdoc-${_rdoc}.gem" \

  msg "cleaning empty rubygems dirs"
  rm -rf "${_gemdir}/build_info" "${_gemdir}/cache" "${_gemdir}/doc" "${_gemdir}/extensions"

  msg "fixing compass compilation error"
  patch -p1 -i compass.patch

  if [[ $_buildBinary = true ]]; then
    msg "building binary files"
    buildBinary
  else
    depends+=("node-webkit")
    msg "skip building binary files"
  fi

  msg "installing files"
  installFiles
}